---
title: "p8105_hw6_yq2378"
author: "Qi Yumeng"
date: "2023-11-28"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r library and seed}
library(tidyverse)
library(plotly)
library(ggpubr)
set.seed(1)
```
# Problem 1


```{r load data}
homicide = read.csv("https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv")

homicide = homicide |>
  mutate(city_state = str_c(city, state, sep=", "),
         if_solved = if_else(disposition == "Closed by arrest",1,0 ),
         victim_age = as.numeric(victim_age)) |>
  filter(!(city_state %in% c('Dallas, TX', 'Phoenix, AZ', 'Kansas City, MO','Tulsa, AL'))) |>
  filter(victim_race %in% c("White", "Black"),
         !is.na(victim_age),
         victim_sex %in% c("Female", "Male")) # delete non-numeric, missing age and Unknown sex
```


```{r baltimore_model}
baltimore_model = glm(if_solved ~ victim_age + victim_sex + victim_race, data = homicide |> filter(city_state =='Baltimore, MD'))
# Apply broom::tidy to the model
baltimore_tidy = broom::tidy(baltimore_model, conf.int = TRUE)
baltimore_tidy
# Extract estimate and confidence interval for the adjusted odds ratio
baltimore_tidy |>
  filter(term == "victim_sexMale") |>
  select(estimate, conf.low, conf.high)
```
Now run glm for each of the cities in your dataset, and extract the adjusted odds ratio (and CI) for solving homicides comparing male victims to female victims. Do this within a “tidy” pipeline, making use of purrr::map, list columns, and unnest as necessary to create a dataframe with estimated ORs and CIs for each city.


```{r}

city_vec = homicide |> pull(city_state) |> unique()
glm_allcities = tibble(
  city_state = city_vec) |>
  mutate(
    fit = map(city_state, ~glm(if_solved ~ victim_age + victim_sex + victim_race, 
                               data = filter(homicide, city_state == .x), 
                               family = "binomial")),
    tidy = map(fit, ~broom::tidy(.x, conf.int = TRUE) |>
                      filter(term == "victim_sexMale") |>
                      select(estimate, conf.low, conf.high))
  ) |>
  unnest('tidy') |>
  select(-fit)
  
```

Create a plot that shows the estimated ORs and CIs for each city. Organize cities according to estimated OR, and comment on the plot.

```{r CI plots}
ggplot(glm_allcities, aes(x = fct_reorder(city_state,estimate), y = estimate)) +
  geom_point(size = 0.8,col = "red") +  
  geom_errorbar(aes(ymin = conf.low,  ymax = conf.high), width = 0.6) + 
  coord_flip() + 
  theme_pubr() + xlab("City State") + ylab("Estimate of the ORs") +
  theme(text = element_text(size = 8),
        plot.margin = unit(c(.1,.1,.1,.1),'cm'))

 
 
```
# Problem 2