p8105_hw6_yq2378
================
Qi Yumeng
2023-11-28

``` r
library(tidyverse)
```

    ## ── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
    ## ✔ dplyr     1.1.3     ✔ readr     2.1.4
    ## ✔ forcats   1.0.0     ✔ stringr   1.5.0
    ## ✔ ggplot2   3.4.4     ✔ tibble    3.2.1
    ## ✔ lubridate 1.9.3     ✔ tidyr     1.3.0
    ## ✔ purrr     1.0.2     
    ## ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
    ## ✖ dplyr::filter() masks stats::filter()
    ## ✖ dplyr::lag()    masks stats::lag()
    ## ℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors

``` r
library(plotly)
```

    ## 
    ## Attaching package: 'plotly'
    ## 
    ## The following object is masked from 'package:ggplot2':
    ## 
    ##     last_plot
    ## 
    ## The following object is masked from 'package:stats':
    ## 
    ##     filter
    ## 
    ## The following object is masked from 'package:graphics':
    ## 
    ##     layout

``` r
library(ggpubr)
set.seed(1)
```

# Problem 1

``` r
homicide = read.csv("https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv")

homicide = homicide |>
  mutate(city_state = str_c(city, state, sep=", "),
         if_solved = if_else(disposition == "Closed by arrest",1,0 ),
         victim_age = as.numeric(victim_age)) |>
  filter(!(city_state %in% c('Dallas, TX', 'Phoenix, AZ', 'Kansas City, MO','Tulsa, AL'))) |>
  filter(victim_race %in% c("White", "Black"),
         !is.na(victim_age),
         victim_sex %in% c("Female", "Male")) # delete non-numeric, missing age and Unknown sex
```

    ## Warning: There was 1 warning in `mutate()`.
    ## ℹ In argument: `victim_age = as.numeric(victim_age)`.
    ## Caused by warning:
    ## ! NAs introduced by coercion

``` r
baltimore_model = glm(if_solved ~ victim_age + victim_sex + victim_race, data = homicide |> filter(city_state =='Baltimore, MD'))
# Apply broom::tidy to the model
baltimore_tidy = broom::tidy(baltimore_model, conf.int = TRUE)
baltimore_tidy
```

    ## # A tibble: 4 × 7
    ##   term             estimate std.error statistic  p.value conf.low  conf.high
    ##   <chr>               <dbl>     <dbl>     <dbl>    <dbl>    <dbl>      <dbl>
    ## 1 (Intercept)       0.570    0.0389       14.7  6.62e-47  0.494    0.647    
    ## 2 victim_age       -0.00150  0.000733     -2.04 4.14e- 2 -0.00293 -0.0000593
    ## 3 victim_sexMale   -0.204    0.0319       -6.38 2.07e-10 -0.266   -0.141    
    ## 4 victim_raceWhite  0.199    0.0400        4.97 7.07e- 7  0.120    0.277

``` r
# Extract estimate and confidence interval for the adjusted odds ratio
baltimore_tidy |>
  filter(term == "victim_sexMale") |>
  select(estimate, conf.low, conf.high)
```

    ## # A tibble: 1 × 3
    ##   estimate conf.low conf.high
    ##      <dbl>    <dbl>     <dbl>
    ## 1   -0.204   -0.266    -0.141

Now run glm for each of the cities in your dataset, and extract the
adjusted odds ratio (and CI) for solving homicides comparing male
victims to female victims. Do this within a “tidy” pipeline, making use
of purrr::map, list columns, and unnest as necessary to create a
dataframe with estimated ORs and CIs for each city.

``` r
city_vec = homicide |> pull(city_state) |> unique()
glm_allcities = tibble(
  city_state = city_vec) |>
  mutate(
    fit = map(city_state, ~glm(if_solved ~ victim_age + victim_sex + victim_race, 
                               data = filter(homicide, city_state == .x), 
                               family = "binomial")),
    tidy = map(fit, ~broom::tidy(.x, conf.int = TRUE) |>
                      filter(term == "victim_sexMale") |>
                      select(estimate, conf.low, conf.high))
  ) |>
  unnest('tidy') |>
  select(-fit)
```

Create a plot that shows the estimated ORs and CIs for each city.
Organize cities according to estimated OR, and comment on the plot.

``` r
ggplot(glm_allcities, aes(x = fct_reorder(city_state,estimate), y = estimate)) +
  geom_point(size = 0.8,col = "red") +  
  geom_errorbar(aes(ymin = conf.low,  ymax = conf.high), width = 0.6) + 
  coord_flip() + 
  theme_pubr() + xlab("City State") + ylab("Estimate of the ORs") +
  theme(text = element_text(size = 8),
        plot.margin = unit(c(.1,.1,.1,.1),'cm'))
```

![](p8105_hw6_ajg2202_files/figure-gfm/CI%20plots-1.png)<!-- --> \#
Problem 2
