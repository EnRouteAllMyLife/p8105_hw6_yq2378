p8105_hw6_yq2378
================
Qi Yumeng
2023-12-01

``` r
library(tidyverse)
```

    ## ── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
    ## ✔ dplyr     1.1.3     ✔ readr     2.1.4
    ## ✔ forcats   1.0.0     ✔ stringr   1.5.0
    ## ✔ ggplot2   3.4.4     ✔ tibble    3.2.1
    ## ✔ lubridate 1.9.3     ✔ tidyr     1.3.0
    ## ✔ purrr     1.0.2     
    ## ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
    ## ✖ dplyr::filter() masks stats::filter()
    ## ✖ dplyr::lag()    masks stats::lag()
    ## ℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors

``` r
library(plotly)
```

    ## 
    ## Attaching package: 'plotly'
    ## 
    ## The following object is masked from 'package:ggplot2':
    ## 
    ##     last_plot
    ## 
    ## The following object is masked from 'package:stats':
    ## 
    ##     filter
    ## 
    ## The following object is masked from 'package:graphics':
    ## 
    ##     layout

``` r
library(ggpubr)
set.seed(1)
```

# Problem 1

``` r
homicide = read.csv("https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv")

homicide = homicide |>
  mutate(city_state = str_c(city, state, sep=", "),
         if_solved = if_else(disposition == "Closed by arrest",1,0 ),
         victim_age = as.numeric(victim_age)) |>
  filter(!(city_state %in% c('Dallas, TX', 'Phoenix, AZ', 'Kansas City, MO','Tulsa, AL'))) |>
  filter(victim_race %in% c("White", "Black"),
         !is.na(victim_age),
         victim_sex %in% c("Female", "Male")) # delete non-numeric, missing age and Unknown sex
```

    ## Warning: There was 1 warning in `mutate()`.
    ## ℹ In argument: `victim_age = as.numeric(victim_age)`.
    ## Caused by warning:
    ## ! NAs introduced by coercion

``` r
# Function to fit logistic regression and extract OR and CI
fit_logistic = function(data) {
  glm_res = glm(if_solved ~ victim_age + victim_sex + victim_race, data = data, family = "binomial")
  tidy_res = broom::tidy(glm_res, exponentiate = TRUE, conf.int = TRUE)
  or_ci = tidy_res |>
    filter(term == "victim_sexMale") |>
    select(estimate, conf.low, conf.high)
  return(or_ci)
}
```

``` r
# Fit logistic regression for Baltimore, MD
homicide |>
  filter(city_state == "Baltimore, MD") |>
  fit_logistic()
```

    ## # A tibble: 1 × 3
    ##   estimate conf.low conf.high
    ##      <dbl>    <dbl>     <dbl>
    ## 1    0.426    0.324     0.558

``` r
# Fit logistic regression for each city and extract OR and CI
city_results = homicide |>
  group_by(city_state) |>
  nest() |>
  mutate(or_ci = map(data, fit_logistic)) |>
  unnest(or_ci) |>
  select(-data) |>
  rename(OR = estimate, CI_low = conf.low, CI_high = conf.high) |>
  arrange(desc(OR))
```

``` r
ggplot(city_results, aes(x = reorder(city_state, OR),
                         y = OR, ymin = CI_low, ymax = CI_high)) +
  geom_point(position = position_dodge(width = 0.5), size = 1, color = "red") +
  geom_errorbar(position = position_dodge(width = 0.5), width = 0.2) +
  geom_hline(yintercept = 1, color = "blue", linetype = 2) +
  labs(title = "Estimated ORs and CIs for Solving Homicides (Male vs. Female)",
       x = "City",
       y = "Odds Ratio") +
  theme_pubclean() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

<img src="p8105_hw6_yq2378_files/figure-gfm/plot for ORs and CIs-1.png" style="display: block; margin: auto;" />

The plot provides a visual representation of the estimated odds ratios
(ORs) and their corresponding confidence intervals (CIs) for 47 cities.
Notably, New York, NY exhibits the smallest OR, while Albuquerque, NM
boasts the largest.

Beginning with Atlanta, GA, a distinct trend emerges: the subsequent six
cities exhibit ORs greater than 1. This implies that in these particular
cities, homicide cases involving male victims are more likely to be
resolved compared to those involving female victims. On the contrary,
the remaining 41 cities in the dataset exhibit an inverse relationship,
signifying that homicides with female victims tend to have higher odds
of resolution.

Regarding the error bars in the plot, it’s notable that the cities
positioned towards the right side generally exhibit wider error bars.
This observation suggests a potential issue related to sample size in
these cities. Wider error bars typically indicate increased uncertainty
in the estimated odds ratios, and this could be attributed to smaller
sample sizes for certain cities.

# Problem 2

``` r
weather = 
  rnoaa::meteo_pull_monitors(
    c("USW00094728"),
    var = c("PRCP", "TMIN", "TMAX"), 
    date_min = "2022-01-01",
    date_max = "2022-12-31") |>
  mutate(
    name = recode(id, USW00094728 = "CentralPark_NY"),
    tmin = tmin / 10,
    tmax = tmax / 10) |>
  select(name, id, everything())
```

    ## Registered S3 method overwritten by 'hoardr':
    ##   method           from
    ##   print.cache_info httr

    ## using cached file: /Users/luchen/Library/Caches/org.R-project.R/R/rnoaa/noaa_ghcnd/USW00094728.dly

    ## date created (size, mb): 2023-12-01 11:24:03.114447 (8.544)

    ## file min/max dates: 1869-01-01 / 2023-11-30

### $\log \left(\hat{\beta}_1 \times \hat{\beta}_2\right)$ Distribution

This distribution has a heavy tail extending to low values and a bit of
a “shoulder”. The density plog of
$\log \left(\hat{\beta}_1 \times \hat{\beta}_2\right)$ values represents
the variability in the logarithmic product of the estimated coefficients
for `tmin` and `prxp` in the linear regression model. The value centers
around -6. This quantity captures the joint effect of the predictors on
`tmax`. The spread provides insights into the uncertainty associated
with this combined predictor influence.

``` r
# prepocessing? 

beta = 
  weather |> 
  modelr::bootstrap(n = 5000) |> 
  mutate(
    models = map(strap, \(df) lm(tmax ~ tmin + prcp, data = df)),
    results = map(models, broom::tidy)) |> 
  select(.id,results) |> 
  unnest(results) |> 
  filter(term %in% c('tmin', 'prcp')) |>
  group_by(.id) |>
  summarise(estimate = log(prod(estimate))) 
```

    ## Warning: There were 3361 warnings in `summarise()`.
    ## The first warning was:
    ## ℹ In argument: `estimate = log(prod(estimate))`.
    ## ℹ In group 2: `.id = "0002"`.
    ## Caused by warning in `log()`:
    ## ! NaNs produced
    ## ℹ Run `dplyr::last_dplyr_warnings()` to see the 3360 remaining warnings.

``` r
CI_beta_squared = quantile(beta$estimate, c(0.025, 0.975),na.rm = TRUE)
ggplot(beta,aes(x = estimate)) + geom_density() + theme_pubclean() + 
  labs(title = "Distribution of log(beta1 * beta2)", x = "log(beta1 * beta2)",
       subtitle = paste("95% CI for R-squared: ","(", round(CI_beta_squared[1],2),", ", round(CI_beta_squared[2],2),")", sep ="")) 
```

    ## Warning: Removed 3361 rows containing non-finite values (`stat_density()`).

<img src="p8105_hw6_yq2378_files/figure-gfm/beta prod-1.png" style="display: block; margin: auto;" />

### $R^2$ Distribution

The distribution of $R^2$ values reflects the variability in how well
the linear regression model explains the variance in the maximum
temperature. The density plot shows a range of $R^2$ values obtained
from 5000 bootstrap samples. It is roughly bell shape. Higher $R^2$
values indicate a better fit of the model, while lower values suggest
less explanatory power. The distribution helps us understand the
uncertainty in estimating the goodness-of-fit for the given predictors
(`tmin` and `prcp`). The most frequent values range from 0.91 to 0.93,
which is a pretty good fit.

``` r
# prepocessing? 
R2 = 
  weather |> 
  modelr::bootstrap(n = 5000) |> 
  mutate(
    models = map(strap, \(df) lm(tmax ~ tmin + prcp, data = df)),
    results = map(models, broom::glance)) |> 
  select(results) |> 
  unnest(results) |>
  select(r.squared) 

CI_r_squared = quantile(R2$r.squared, c(0.025, 0.975))
ggplot(R2,aes(x = r.squared)) + geom_density() + theme_pubclean() + 
  labs(title = "Distribution of R-squared", x = "R-squared",
       subtitle = paste("95% CI for R-squared: ","(", round(CI_r_squared[1],2),", ", round(CI_r_squared[2],2),")", sep ="")) 
```

<img src="p8105_hw6_yq2378_files/figure-gfm/R2 prod-1.png" style="display: block; margin: auto;" />
